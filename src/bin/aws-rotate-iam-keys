#!/usr/bin/env bash

# Assign the arguments to variables
for arg in "$@"
do
case "$arg" in
    -p|--profiles|--profile)
    PROFILES="$2"
    ;;
    --version|-v|version)
      echo "AWS Rotate IAM Keys (c) 2018 Adam Link"
      echo "version ${VERSION}"
      exit 0
    ;;
    --help|help|-h)
    echo '''
    To rotate your default profile manually:
    $ aws-rotate-iam-keys

    To rotate a specific profile in your `~/.aws/credentials` file:
    $ aws-rotate-iam-keys --profile myProfile

    To rotate multiple profiles *with the same key*:
    $ aws-rotate-iam-keys --profiles myProfile,myOtherProfile

    To rotate multiple profiles *with their own keys*:
    $ aws-rotate-iam-keys --profile myProfile
    $ aws-rotate-iam-keys --profile myOtherProfile
    '''
    exit 0
    ;;
esac
done

# Set the profile to default if nothing sent via CLI
if [[ -z "$1" ]]; then
	PROFILES=default
fi

set -f                      # avoid globbing (expansion of *).
PROFILES_ARR=(${PROFILES//,/ })
FIRST_PROFILE=${PROFILES_ARR[0]}

CURRENT_KEY_ID=$(aws iam list-access-keys --output json --profile $FIRST_PROFILE | jq '.AccessKeyMetadata[0].AccessKeyId' | tr -d '"' || exit 1)

if [[ "$CURRENT_KEY_ID" != "" ]]; then
  # Make a new key
  echo "Making new access key"
  RESPONSE=$(aws iam create-access-key --profile $FIRST_PROFILE | jq .AccessKey)
  ACCESS_KEY=$(echo $RESPONSE | jq '.AccessKeyId' | tr -d '"')
  SECRET=$(echo $RESPONSE | jq '.SecretAccessKey' | tr -d '"')
  if [[ "$ACCESS_KEY" != "" && "$SECRET" != "" ]]; then
    aws iam delete-access-key --access-key-id $CURRENT_KEY_ID --profile ${PROFILES_ARR[i]}

    # Rotate the keys in the credentials file for all profiles
    for i in "${!PROFILES_ARR[@]}"
    do
        echo "Updating profile: ${PROFILES_ARR[i]}"
        aws configure set aws_access_key_id $ACCESS_KEY --profile ${PROFILES_ARR[i]}
        aws configure set aws_secret_access_key $SECRET --profile ${PROFILES_ARR[i]}
    done

    echo "Made new key $ACCESS_KEY"
    echo "Key rotated"
    exit 0
  else
    echo "Could not create access key. Ensure you only have 1 active access key in your IAM profile."
    exit 1
  fi
else
  echo "Could not find current key. Please ensure you have a profile set up using `aws configure`."
  exit 1
fi
